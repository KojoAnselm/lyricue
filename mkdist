#!/bin/bash
if [ "$1" = "release" ] 
then echo Making release
CHANGELOG="debian/changelog-release"
else CHANGELOG="debian/changelog"
fi

PACKAGE=`head -1 ${CHANGELOG} | cut -f1 -d" "`
VERSION=`head -1 ${CHANGELOG} |sed -e 's/^.*(\(.*\)).*$/\1/g'|sed -e 's/^.://g'`
LC_ALL=C;export LC_ALL
BUILD_DIR=~/source/Lyricue/dist

echo Removing old ${BUILD_DIR} files
rm -rf ${BUILD_DIR}/l*

echo Creating new files
mkdir ${BUILD_DIR}
mkdir ${BUILD_DIR}/lyricue-${VERSION}
cp -R * ${BUILD_DIR}/lyricue-${VERSION}
rm -rf ${BUILD_DIR}/${BUILD_DIR}
rm -rf ${BUILD_DIR}/lyricue-${VERSION}/bibles
rm -rf ${BUILD_DIR}/lyricue-${VERSION}/${BUILD_DIR}
rm ${BUILD_DIR}/lyricue-${VERSION}/ChangeLog.bak

pushd ${BUILD_DIR}/lyricue-${VERSION}
CONV="s/##VERSION##/${VERSION}/g"
for F in import_media lyricue lyricue.1 lyricue_server lyricue.glade
do sed --in-place -e $CONV $F
done

if [ "$1" = "release" ] 
then mv debian/changelog-release debian/changelog
  CONV="s/lyricue-cvs/${PACKAGE}/g"
  for F in debian/control debian/menu debian/rules
  do sed --in-place -e $CONV $F
  done
else rm debian/changelog-release
fi


rm images/*.svg
find . -name CVS -type d -exec rm -r \{} \; 2>/dev/null
make

echo Creating Debian packages
dpkg-buildpackage -rfakeroot -kB734D1F5 -pgnome-gpg
popd
rm -rf ${BUILD_DIR}/lyricue-${VERSION}/debian
pushd ${BUILD_DIR}
tar cvfz lyricue*_${VERSION}.tar.gz lyricue-${VERSION}
popd

rm -rf ${BUILD_DIR}/lyricue-${VERSION}


# Bibles no longer provided in deb format
#echo Making Bible packages
#if [ "$1" = "-b" ]
#then echo Making bibles
#for DB in KJV MES NIV NLT NIRV
#    do DB_LOWER=`echo $DB | tr [:upper:] [:lower:]`
#    ${BUILD_DIR}DIR=${BUILD_DIR}/lyricue-bible-$DB_LOWER
#    mkdir $${BUILD_DIR}DIR
#    mkdir $${BUILD_DIR}DIR/mysql
#    mkdir $${BUILD_DIR}DIR/debian
#    cp mysql/MySQL_create_bible_$DB.sql $${BUILD_DIR}DIR/mysql
#    cp debian/bibles/$DB/* $${BUILD_DIR}DIR/debian
#    pushd $${BUILD_DIR}DIR/debian
#    popd
#    pushd $${BUILD_DIR}DIR
#    dpkg-buildpackage -rfakeroot
#    popd
#    rm -rf $${BUILD_DIR}DIR
#done
#fi

echo Pushing to repository
cp ${BUILD_DIR}/*deb ${BUILD_DIR}/*.dsc ${BUILD_DIR}/*.asc ${BUILD_DIR}/*.gz ${BUILD_DIR}/*.changes  /var/www/debian
update_repo
