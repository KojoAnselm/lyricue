#!/bin/bash

VERSION=`head -1 debian/changelog |sed -e 's/^.*(\(.*\)).*$/\1/g'|sed -e 's/^.://g'`
LC_ALL=C;export LC_ALL

echo Removing old dist files
rm -rf dist/l*

echo Creating new files
mkdir dist
mkdir dist/lyricue-${VERSION}
cp -R * dist/lyricue-${VERSION}
rm -rf dist/dist
rm dist/lyricue-${VERSION}/mysql/MySQL_create_bible_*.sql
rm -rf dist/lyricue-${VERSION}/debian/bible

pushd dist/lyricue-${VERSION}
rm -rf dist
rm images/desktop.png images/*.svg
find . -name CVS -type d -exec rm -r \{} \; 2>/dev/null
make

echo Creating Debian packages
dpkg-buildpackage -rfakeroot -kB734D1F5
popd
rm -rf dist/lyricue-${VERSION}

echo Making Bible packages
if [ "$1" = "-b" ]
then echo Making bibles
for DB in KJV MES NIV NLT NIRV
    do DB_LOWER=`echo $DB | tr [:upper:] [:lower:]`
    DISTDIR=dist/lyricue-bible-$DB_LOWER
    mkdir $DISTDIR
    mkdir $DISTDIR/mysql
    mkdir $DISTDIR/debian
    cp mysql/MySQL_create_bible_$DB.sql $DISTDIR/mysql
    cp debian/bibles/$DB/* $DISTDIR/debian
    pushd $DISTDIR/debian
    popd
    pushd $DISTDIR
    dpkg-buildpackage -rfakeroot
    popd
    rm -rf $DISTDIR
done
fi

echo Pushing to repository
cp dist/*deb dist/*.dsc dist/*.asc dist/*.gz dist/*.changes  /var/www/debian
cd /var/www/debian
rm Packages.gz Sources.gz Packages.bz2 Sources.bz2 Release Release.gpg
apt-ftparchive packages . > Packages
apt-ftparchive sources . > Sources
apt-ftparchive release . > /tmp/a
gzip Packages
gzip Sources
mv /tmp/a Release
gpg -abs -o Release.gpg Release
