#!/bin/bash

# Update changelog
cvs2cl

BUILD_DIR=~/source/Lyricue/dist
rm -rf ${BUILD_DIR}/l*

if [ "$1" = "release" ] 
then echo Making release
CHANGELOG="debian/changelog-release"
cat debian/rules-base | sed -e 's/lyricue-cvs/lyricue/g' > debian/rules
chmod +x debian/rules
cat debian/menu-base | sed -e 's/lyricue-cvs/lyricue/g' > debian/menu
else CHANGELOG="debian/changelog-cvs"
cp debian/rules-base debian/rules
cp debian/menu-base debian/menu
fi

VERSION=`head -1 ${CHANGELOG} |sed -e 's/^.*(\(.*\)).*$/\1/g'|sed -e 's/^.://g'`
LC_ALL=C;export LC_ALL

echo Creating new files
mkdir ${BUILD_DIR}
mkdir ${BUILD_DIR}/lyricue-${VERSION}
cp -R * ${BUILD_DIR}/lyricue-${VERSION}
rm -rf ${BUILD_DIR}/${BUILD_DIR}
rm -rf ${BUILD_DIR}/lyricue-${VERSION}/${BUILD_DIR}
find ${BUILD_DIR}/lyricue-${VERSION} -type d -name CVS -exec rm -rf \{} \;

pushd ${BUILD_DIR}/lyricue-${VERSION}
rm ChangeLog.bak debian/menu-base debian/rules-base
pod2man lyricue > lyricue.1
pod2man lyricue_server > lyricue_server.1
pod2man lyricue_remote > lyricue_remote.1

CONV="s/##VERSION##/${VERSION}/g"
for F in import_media lyricue lyricue.1 lyricue_server lyricue.glade
do sed --in-place -e $CONV $F
done


for DIST in intrepid jaunty karmic lucid
do echo Building for ${DIST}
if [ "$1" = "release" ]
then cat debian/control-${DIST} | sed -e 's/lyricue-cvs/lyricue/g' > debian/control
else cp debian/control-${DIST} debian/control
fi
cat ${CHANGELOG} | head -1 | sed -e "s/karmic/$DIST/g" -e "s/)/${DIST})/g"  > debian/changelog
echo "" >> debian/changelog
echo "  * Build for ${DIST}" >> debian/changelog
echo "" >> debian/changelog
echo " -- Chris Debenham <chris@adebenham.com> " `date -R` >> debian/changelog
echo "" >> debian/changelog
cat $CHANGELOG >> debian/changelog
debuild -S -sa -kB734D1F5
done

# Cleanup
rm debian/rules debian/changelog debian/control debian/menu

echo "dput ppa:chris-debenham/lyricue ../dist/lyricue*_source.changes"
