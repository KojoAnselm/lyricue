#!/bin/bash

#Update changelog
bzr log --gnu > ChangeLog

CHANGELOG=debian/changelog
VERSION=`head -1 ${CHANGELOG} |sed -e 's/^.*(\(.*\)).*$/\1/g'|sed -e 's/^.://g'`
LC_ALL=C;export LC_ALL

CONV="s/##VERSION##/${VERSION}/g"
for F in src/lyricue data/lyricue.glade
do sed --in-place -e $CONV $F
done

#DIST=maverick
#echo Building for ${DIST}
#bzr-buildpackage -S

if [ "$1" = "release" ] 
then echo Making release
sed --in-place -e "s/lyricue3/lyricue/g" -e "s/lyricue,/lyricue3,/g" debian/control
fi

for DIST in maverick karmic lucid
do echo Building for ${DIST}
if [ "$1" = "release" ]
then echo Making release
sed --in-place -e "s/lyricue3/lyricue/g" -e "s/lyricue,/lyricue3,/g" ${CHANGELOG}
fi 

if [ "$DIST" != "maverick" ]
then cat ${CHANGELOG} | head -1 | sed -e "s/maverick/$DIST/g" -e "s/)/${DIST})/g"  > debian/changelog-new
echo "" >> debian/changelog-new
echo "  * Build for ${DIST}" >> debian/changelog-new
echo "" >> debian/changelog-new
echo " -- Chris Debenham <chris@adebenham.com> " `date -R` >> debian/changelog-new
echo "" >> debian/changelog-new
cat $CHANGELOG >> debian/changelog-new
mv debian/changelog-new debian/changelog
fi
bzr-buildpackage -S
bzr revert debian/changelog
done

# Put things back to how they were
if [ "$1" = "release" ] 
then bzr revert debian/control
fi

bzr revert src/lyricue
rm src/lyricue.~*~
rm debian/changelog.~*~

echo dput ppa:chris-debenham/lyricue `ls -r ../*.changes`

